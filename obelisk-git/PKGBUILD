# Maintainer: Andy Weidenbaum <archbaum@gmail.com>

pkgname=obelisk-git
pkgver=20140321
pkgrel=1
pkgdesc="Obelisk of light scalable Bitcoin infrastructure"
arch=('i686' 'x86_64')
depends=('czmq-git' 'czmqpp-git' 'libbitcoin-leveldb-git' 'libsodium' 'zeromq-git')
makedepends=('gcc' 'git' 'libconfig' 'libtool' 'make')
url="https://github.com/spesmilo/obelisk"
license=('AGPL3')
source=(git+https://github.com/spesmilo/obelisk
        obelisk.logrotate
        obelisk.service
        sx-initchain.service)
sha256sums=('SKIP'
            '135376afc6cdea0dd60c9c4618753b8cd56c880b36d31c773932e0f75a5f421c'
            '287150510abc0c55f43623eb9b6e97541dac545e72d6f7bc99f6f2e8b0867695'
            '80f1a24539aec062c7069fc783aa5f1a73482329a39e2cc85bb6ac907d024733')
provides=('obelisk')
conflicts=('obelisk')
install=obelisk.install

pkgver() {
  cd ${pkgname%-git}
  git log -1 --format="%cd" --date=short | sed "s|-||g"
}

prepare() {
  cd ${pkgname%-git}

  msg 'Configuring obelisk worker...'
  sed -i 's!^output-file.*!output-file = "/var/log/obelisk/debug.log"!' src/worker/worker.cfg
  sed -i 's!^error-file.*!error-file = "/var/log/obelisk/error.log"!'   src/worker/worker.cfg
  sed -i 's!^blockchain-path.*!blockchain-path = "/srv/blockchain/"!'   src/worker/worker.cfg
}

build() {
  cd ${pkgname%-git}

  msg 'Building obelisk...'
  ./autogen.sh
  ./configure \
    --prefix=/usr \
    --sbindir=/usr/bin \
    --libexecdir=/usr/lib/obelisk \
    --sysconfdir=/etc \
    --sharedstatedir=/usr/share/obelisk \
    --localstatedir=/var/lib/obelisk \
    --with-gnu-ld
  make
}

package() {
  cd ${pkgname%-git}

  msg 'Installing license...'
  install -Dm 644 COPYING $pkgdir/usr/share/licenses/obelisk/COPYING

  msg 'Installing appdirs...'
  install -dm 755 $pkgdir/srv/blockchain
  install -dm 755 $pkgdir/usr/share/obelisk
  install -dm 700 $pkgdir/var/log/obelisk
  for _appdir in scripts; do
    mv $_appdir $pkgdir/usr/share/obelisk/$_appdir
  done

  msg 'Installing obelisk...'
  make DESTDIR="$pkgdir" install

  msg 'Installing obelisk service files...'
  install -Dm 644 $srcdir/obelisk.service $pkgdir/usr/lib/systemd/system/obelisk.service
  install -Dm 644 $srcdir/sx-initchain.service $pkgdir/usr/lib/systemd/system/sx-initchain.service

  msg 'Cleaning up pkgdir...'
  find "$pkgdir" -type d -name .git -exec rm -r '{}' +
  find "$pkgdir" -type f -name .gitignore -exec rm -r '{}' +
}
